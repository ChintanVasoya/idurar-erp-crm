name: Deploy to VM

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/crm-demo-key
          chmod 600 ~/.ssh/crm-demo-key
          echo "Host 104.154.114.203
            IdentityFile ~/.ssh/crm-demo-key
            User akash_contextqa_com
            StrictHostKeyChecking no" > ~/.ssh/config
          chmod 600 ~/.ssh/config

      - name: Deploy to VM
        run: |
          echo "ðŸ“¥ Checking and deploying latest code to VM..."
          ssh 104.154.114.203 "
            if [ ! -d ~/idurar-erp-crm ]; then
              echo 'Repository does not exist, cloning...'
              git clone https://github.com/akashshah/crm-demo.git ~/idurar-erp-crm
            else
              echo 'Repository exists, updating...'
              cd ~/idurar-erp-crm && git pull origin master
            fi
          "
          scp -r ./ 104.154.114.203:~/idurar-erp-crm

          echo "ðŸš€ Deploying with docker-compose on VM..."
          ssh 104.154.114.203 "
            cd ~/idurar-erp-crm &&
            docker-compose -f ~/idurar-erp-crm/docker-compose.yml down &&
            docker-compose -f ~/idurar-erp-crm/docker-compose.yml build --no-cache &&
            docker-compose -f ~/idurar-erp-crm/docker-compose.yml up -d
          "
